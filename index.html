<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkTrackX | SMK Ayer Keroh</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --neon-cyan: #00f2ff;
            --neon-pink: #ff00e5;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --bg-dark: #0d0d12;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 242, 255, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 229, 0.1) 0%, transparent 40%);
            color: #fff;
            min-height: 100vh;
        }

        .font-orbitron { font-family: 'Orbitron', sans-serif; }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        .neon-text-cyan { color: var(--neon-cyan); text-shadow: 0 0 5px var(--neon-cyan); }
        .neon-text-pink { color: var(--neon-pink); text-shadow: 0 0 5px var(--neon-pink); }

        .btn-glow-cyan:hover {
            box-shadow: 0 0 20px var(--neon-cyan);
            background: var(--neon-cyan);
            color: #000;
        }

        .btn-glow-pink:hover {
            box-shadow: 0 0 20px var(--neon-pink);
            background: var(--neon-pink);
            color: #000;
        }

        /* Custom Checkbox */
        .checkbox-container input { display: none; }
        .checkbox-custom {
            width: 24px;
            height: 24px;
            border: 2px solid var(--neon-cyan);
            border-radius: 6px;
            display: inline-block;
            vertical-align: middle;
            position: relative;
            transition: all 0.3s;
        }
        .checkbox-container input:checked + .checkbox-custom {
            background: var(--neon-cyan);
            box-shadow: 0 0 10px var(--neon-cyan);
        }
        .checkbox-container input:checked + .checkbox-custom::after {
            content: '✓';
            position: absolute;
            color: #000;
            font-weight: bold;
            left: 4px;
            top: -2px;
        }

        /* Toast Animation */
        #toast {
            visibility: hidden;
            min-width: 250px;
            transform: translateX(-50%);
            transition: opacity 0.5s, bottom 0.5s;
            left: 50%;
            bottom: -100px;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 30px;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--glass-bg); border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Header -->
    <header class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div class="text-center md:text-left">
            <h1 class="font-orbitron text-xl md:text-2xl neon-text-cyan leading-tight uppercase">
                REKOD PENGHANTARAN BUKU – PENDIDIKAN MORAL
            </h1>
            <p class="font-orbitron text-sm neon-text-pink tracking-widest">SMK AYER KEROH</p>
        </div>
        <div class="flex items-center gap-4">
            <span id="lastSaved" class="text-xs text-gray-400 italic"></span>
            <button id="adminBtn" class="glass p-3 border border-pink-500 rounded-full hover:bg-pink-500 transition-all duration-300">
                <i data-lucide="lock" class="w-5 h-5 text-pink-400"></i>
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto">
        <!-- MOD GURU -->
        <section id="guruMode" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glass p-6 space-y-4 border-l-4 border-cyan-500">
                    <div>
                        <label class="block text-xs uppercase tracking-widest mb-2 opacity-70">Pilih Kelas</label>
                        <select id="selectKelas" class="w-full bg-black/40 border border-gray-700 rounded-lg p-3 focus:outline-none focus:border-cyan-400 transition-colors">
                            <option value="">-- Pilih Kelas --</option>
                            <option value="T4-ABMPVG3">TINGKATAN 4 A,B,MPV,G3</option>
                            <option value="T5-AMPV">TINGKATAN 5 A & MPV</option>
                            <option value="T5-G2G3">TINGKATAN 5 G2 & G3</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-widest mb-2 opacity-70">Tarikh Rekod</label>
                        <input type="date" id="selectTarikh" class="w-full bg-black/40 border border-gray-700 rounded-lg p-3 focus:outline-none focus:border-cyan-400 transition-colors">
                    </div>
                </div>

                <div class="glass p-6 flex flex-col justify-center items-center border-l-4 border-pink-500 text-center">
                    <div class="relative w-32 h-32 mb-2">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="64" cy="64" r="58" stroke="currentColor" stroke-width="8" fill="transparent" class="text-gray-800" />
                            <circle id="progressCircle" cx="64" cy="64" r="58" stroke="currentColor" stroke-width="8" fill="transparent" stroke-dasharray="364.4" stroke-dashoffset="364.4" class="text-cyan-400 transition-all duration-1000" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="progressText" class="text-2xl font-orbitron font-bold">0%</span>
                            <span class="text-[10px] uppercase opacity-60">Dihantar</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="studentListContainer" class="glass p-6 hidden">
                <h2 class="font-orbitron text-lg mb-4 border-b border-gray-700 pb-2">Senarai Nama Murid</h2>
                <div id="studentList" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6"></div>
                <div class="flex flex-wrap gap-3 border-t border-gray-700 pt-6">
                    <button id="saveBtn" class="flex-1 min-w-[150px] bg-cyan-600/20 border border-cyan-400 py-3 rounded-lg font-orbitron text-sm btn-glow-cyan transition-all uppercase">Simpan Rekod Hari Ini</button>
                    <button id="resetBtn" class="flex-1 min-w-[150px] bg-gray-600/20 border border-gray-500 py-3 rounded-lg font-orbitron text-sm hover:bg-gray-500 transition-all uppercase">Reset Tick</button>
                    <button id="exportBtn" class="flex-1 min-w-[150px] bg-pink-600/20 border border-pink-400 py-3 rounded-lg font-orbitron text-sm btn-glow-pink transition-all uppercase">Export CSV</button>
                </div>
            </div>

            <div id="placeholderMsg" class="glass p-12 text-center text-gray-500 flex flex-col items-center gap-4">
                <i data-lucide="clipboard-list" class="w-12 h-12 opacity-30"></i>
                <p>Sila pilih kelas untuk mula merekod penghantaran buku.</p>
            </div>
        </section>

        <!-- MOD ADMIN -->
        <section id="adminMode" class="hidden space-y-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-orbitron text-2xl neon-text-pink">ADMIN DASHBOARD</h2>
                <button id="backToGuru" class="text-sm border border-cyan-500 px-4 py-2 rounded hover:bg-cyan-500 hover:text-black transition-all">MOD GURU</button>
            </div>

            <div class="glass p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs uppercase mb-2 opacity-70">Kelas</label>
                    <select id="adminSelectKelas" class="w-full bg-black/40 border border-gray-700 rounded p-2 focus:outline-none">
                        <option value="T4-ABMPVG3">TINGKATAN 4 A,B,MPV,G3</option>
                        <option value="T5-AMPV">TINGKATAN 5 A & MPV</option>
                        <option value="T5-G2G3">TINGKATAN 5 G2 & G3</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs uppercase mb-2 opacity-70">Mod Filter</label>
                    <select id="adminFilterMode" class="w-full bg-black/40 border border-gray-700 rounded p-2 focus:outline-none">
                        <option value="daily">Harian</option>
                        <option value="weekly">Mingguan</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs uppercase mb-2 opacity-70">Tarikh Rujukan</label>
                    <input type="date" id="adminDate" class="w-full bg-black/40 border border-gray-700 rounded p-2 focus:outline-none">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="glass p-6 text-center">
                    <p class="text-xs uppercase opacity-70 mb-1">Dihantar (%)</p>
                    <p id="kpiHantar" class="text-4xl font-orbitron neon-text-cyan">0%</p>
                </div>
                <div class="glass p-6 text-center">
                    <p class="text-xs uppercase opacity-70 mb-1">Tidak Hantar (%)</p>
                    <p id="kpiGagal" class="text-4xl font-orbitron neon-text-pink">0%</p>
                </div>
                <div class="glass p-6 text-center">
                    <p class="text-xs uppercase opacity-70 mb-1">Jumlah Data</p>
                    <p id="kpiTotal" class="text-4xl font-orbitron">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glass p-6 h-80"><canvas id="dailyChart"></canvas></div>
                <div class="glass p-6 h-80"><canvas id="weeklyChart"></canvas></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glass p-6">
                    <h3 class="font-orbitron text-sm mb-4 text-cyan-400">TOP 3 - KERAP HANTAR</h3>
                    <div id="topHantar" class="space-y-3"></div>
                </div>
                <div class="glass p-6">
                    <h3 class="font-orbitron text-sm mb-4 text-pink-400">TOP 3 - KERAP TIDAK HANTAR</h3>
                    <div id="topTidak" class="space-y-3"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Login -->
    <div id="loginModal" class="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50 hidden">
        <div class="glass p-8 w-full max-w-sm border border-pink-500 shadow-[0_0_20px_rgba(255,0,229,0.3)]">
            <h2 class="font-orbitron text-xl mb-6 text-center">PENGESAHAN ADMIN</h2>
            <input type="password" id="adminPassword" placeholder="Masukkan Password" class="w-full bg-black/50 border border-pink-500 p-3 rounded-lg mb-4 text-center tracking-[0.5em] focus:outline-none">
            <div class="flex gap-2">
                <button id="loginConfirm" class="flex-1 bg-pink-600 py-2 rounded font-orbitron hover:bg-pink-500 transition-all">MASUK</button>
                <button id="loginCancel" class="flex-1 bg-gray-700 py-2 rounded font-orbitron">BATAL</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed glass border-cyan-400 border px-6 py-3 rounded-full z-50 shadow-2xl flex items-center gap-2 text-cyan-300">
        <i data-lucide="check-circle" class="w-5 h-5"></i>
        <span id="toastMsg">Rekod disimpan ✅</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const STUDENTS = {
            "T4-ABMPVG3": ["ANOUSHKA A/P KATHIRASAN", "KAVINASH A/L SHASHITHARAN MUDALIAR", "RAUL A/L EDWIN ANTHONY", "PRAMANANTTHA A/L CHANDERA MOHAN", "PURVIN A/L MUNIANDY"],
            "T5-AMPV": ["AKSHEY A/L GOPI", "ASWARYA A/P KATHIRASAN", "JIVANESH A/L MOHAN", "OVIA A/P KOGELAN", "SHARWIN A/L TARMENDRAN", "THIRUSSHEN KUMAR A/L SENTHIL KUMAR", "ANDREW ISAIAH ALAN A/L ALAN THURAI"],
            "T5-G2G3": ["EBENEZER A/L NYANAPRAGASAM", "RITIKA NAIR A/P RAVINDRAN", "VIMAL A/L JEYAKUMAR", "HAYLIE DOUGLAS ANAK LOCUS", "KUGENDRAN A/L K GANESAN"]
        };

        const STORAGE_KEY = "worktrackx_records";
        let db, auth, userId, appId;
        let dChart, wChart;

        window.onload = async () => {
            lucide.createIcons();
            
            try {
                const config = JSON.parse(__firebase_config);
                const app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'smkak-worktrackx';

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                await initAuth();

                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; }
                    initUI();
                });
            } catch (e) {
                console.warn("Firebase config not available or invalid, using offline mode.");
                initUI();
            }
        };

        function initUI() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('selectTarikh').value = today;
            document.getElementById('adminDate').value = today;

            document.getElementById('selectKelas').onchange = renderList;
            document.getElementById('selectTarikh').onchange = renderList;
            document.getElementById('saveBtn').onclick = saveRecord;
            document.getElementById('resetBtn').onclick = () => {
                document.querySelectorAll('.student-checkbox').forEach(c => c.checked = false);
                updateStats();
            };
            document.getElementById('exportBtn').onclick = exportCSV;
            document.getElementById('adminBtn').onclick = () => document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginCancel').onclick = () => document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginConfirm').onclick = () => {
                if(document.getElementById('adminPassword').value === "mea2100"){
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('guruMode').classList.add('hidden');
                    document.getElementById('adminMode').classList.remove('hidden');
                    refreshAdmin();
                } else { alert("Password Salah!"); }
            };
            document.getElementById('backToGuru').onclick = () => {
                document.getElementById('adminMode').classList.add('hidden');
                document.getElementById('guruMode').classList.remove('hidden');
            };
            document.getElementById('adminSelectKelas').onchange = refreshAdmin;
            document.getElementById('adminFilterMode').onchange = refreshAdmin;
            document.getElementById('adminDate').onchange = refreshAdmin;
        }

        function renderList() {
            const kelas = document.getElementById('selectKelas').value;
            const tarikh = document.getElementById('selectTarikh').value;
            const list = document.getElementById('studentList');
            const cont = document.getElementById('studentListContainer');
            const msg = document.getElementById('placeholderMsg');

            if(!kelas || !STUDENTS[kelas]) { 
                cont.classList.add('hidden'); 
                msg.classList.remove('hidden'); 
                return; 
            }

            cont.classList.remove('hidden');
            msg.classList.add('hidden');
            list.innerHTML = '';

            // 1. Bina senarai nama serta-merta (Pantas)
            STUDENTS[kelas].forEach(name => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 glass p-4 hover:bg-white/5 transition-colors cursor-pointer group";
                div.innerHTML = `
                    <label class="checkbox-container flex items-center gap-3 w-full cursor-pointer">
                        <input type="checkbox" class="student-checkbox" data-name="${name}">
                        <span class="checkbox-custom"></span>
                        <span class="text-sm group-hover:text-cyan-300 transition-colors">${name}</span>
                    </label>
                `;
                div.onclick = (e) => {
                    if(e.target.tagName !== 'INPUT') {
                        const cb = div.querySelector('input');
                        cb.checked = !cb.checked;
                        updateStats();
                    }
                };
                list.appendChild(div);
            });

            lucide.createIcons();
            updateStats();

            // 2. Kemudian baru cuba ambil data "tick" dari Firebase secara asinkronus
            loadTicksFromFirebase(tarikh, kelas);
        }

        async function loadTicksFromFirebase(tarikh, kelas) {
            if(!db || !appId) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', STORAGE_KEY, tarikh);
                const snap = await getDoc(docRef);
                if(snap.exists() && snap.data()[kelas]) {
                    const data = snap.data()[kelas];
                    document.querySelectorAll('.student-checkbox').forEach(cb => {
                        if (data[cb.dataset.name] !== undefined) {
                            cb.checked = data[cb.dataset.name] === true;
                        }
                    });
                    updateStats();
                }
            } catch(e) {
                console.error("Firebase fetch error:", e);
            }
        }

        function updateStats() {
            const boxes = document.querySelectorAll('.student-checkbox');
            const total = boxes.length;
            const done = Array.from(boxes).filter(b => b.checked).length;
            const pct = total > 0 ? Math.round((done/total)*100) : 0;
            document.getElementById('progressText').innerText = pct + '%';
            document.getElementById('progressCircle').style.strokeDashoffset = 364.4 - (pct/100)*364.4;
        }

        async function saveRecord() {
            const k = document.getElementById('selectKelas').value;
            const t = document.getElementById('selectTarikh').value;
            if(!k) { alert("Sila pilih kelas."); return; }
            if(!db) { alert("Pangkalan data tidak sedia. Sila semak sambungan internet."); return; }

            const btn = document.getElementById('saveBtn');
            btn.innerText = "MENYIMPAN...";
            btn.disabled = true;

            const data = {};
            document.querySelectorAll('.student-checkbox').forEach(c => data[c.dataset.name] = c.checked);

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', STORAGE_KEY, t);
                const snap = await getDoc(docRef);
                const current = snap.exists() ? snap.data() : {};
                current[k] = data;
                await setDoc(docRef, current);
                showToast("Rekod disimpan ✅");
                const now = new Date();
                document.getElementById('lastSaved').innerText = `Terakhir: ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            } catch(e) { 
                console.error(e);
                showToast("Ralat menyimpan ❌"); 
            }
            finally { btn.innerText = "SIMPAN REKOD HARI INI"; btn.disabled = false; }
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = m;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        async function refreshAdmin() {
            const k = document.getElementById('adminSelectKelas').value;
            const m = document.getElementById('adminFilterMode').value;
            const dStr = document.getElementById('adminDate').value;
            const dates = [];

            if(m === 'daily') dates.push(dStr);
            else {
                const d = new Date(dStr);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                const mon = new Date(d.setDate(diff));
                for(let i=0; i<5; i++){
                    const next = new Date(mon);
                    next.setDate(mon.getDate() + i);
                    dates.push(next.toISOString().split('T')[0]);
                }
            }

            const results = {};
            if (db) {
                for(const dt of dates) {
                    try {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', STORAGE_KEY, dt);
                        const s = await getDoc(docRef);
                        if(s.exists() && s.data()[k]) results[dt] = s.data()[k];
                    } catch(e) {}
                }
            }

            let totalPossible = dates.length * STUDENTS[k].length;
            let totalHantar = 0;
            const studentStats = {};
            STUDENTS[k].forEach(n => studentStats[n] = { h: 0, t: 0 });

            dates.forEach(dt => {
                STUDENTS[k].forEach(n => {
                    if(results[dt] && results[dt][n] === true) { totalHantar++; studentStats[n].h++; }
                    else { studentStats[n].t++; }
                });
            });

            const pctH = totalPossible > 0 ? Math.round((totalHantar/totalPossible)*100) : 0;
            document.getElementById('kpiHantar').innerText = pctH + '%';
            document.getElementById('kpiGagal').innerText = (100 - pctH) + '%';
            document.getElementById('kpiTotal').innerText = totalPossible;

            if(dChart) dChart.destroy();
            dChart = new Chart(document.getElementById('dailyChart'), {
                type: 'doughnut',
                data: { labels: ['Hantar', 'Tiada'], datasets: [{ data: [pctH, 100-pctH], backgroundColor: ['#00f2ff','#ff00e5'] }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
            });

            const weeklyData = dates.map(dt => {
                if(!results[dt]) return 0;
                const h = Object.values(results[dt]).filter(v => v === true).length;
                return Math.round((h/STUDENTS[k].length)*100);
            });

            if(wChart) wChart.destroy();
            wChart = new Chart(document.getElementById('weeklyChart'), {
                type: 'bar',
                data: { labels: ['Mon','Tue','Wed','Thu','Fri'], datasets: [{ label: '% Hantar', data: weeklyData, backgroundColor: '#00f2ff' }] },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } } }
            });

            const topH = Object.entries(studentStats).sort((a,b) => b[1].h - a[1].h).slice(0,3);
            const topT = Object.entries(studentStats).sort((a,b) => b[1].t - a[1].t).slice(0,3);
            document.getElementById('topHantar').innerHTML = topH.map(s => `<div class="glass p-2 text-xs flex justify-between"><span>${s[0]}</span><span class="neon-text-cyan">${s[1].h} Hari</span></div>`).join('');
            document.getElementById('topTidak').innerHTML = topT.map(s => `<div class="glass p-2 text-xs flex justify-between"><span>${s[0]}</span><span class="neon-text-pink">${s[1].t} Hari</span></div>`).join('');
        }

        function exportCSV() {
            const k = document.getElementById('selectKelas').value;
            const t = document.getElementById('selectTarikh').value;
            let c = `Bil,Nama,Status\n`;
            document.querySelectorAll('.student-checkbox').forEach((cb,i) => {
                c += `${i+1},"${cb.dataset.name}",${cb.checked ? 'HANTAR' : 'TIDAK'}\n`;
            });
            const b = new Blob([c], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `WorkTrackX_${k}_${t}.csv`;
            a.click();
        }
    </script>
</body>
</html>